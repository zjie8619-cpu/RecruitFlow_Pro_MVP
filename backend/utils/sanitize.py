# ======================================================
# ğŸš« AIè¾“å‡ºé˜²å¹»è§‰æ€»æ§æ¨¡å— (Final Stable Version)
# åŠŸèƒ½ï¼š
#   - ä»æºå¤´ç¦æ­¢AIç¼–é€ æ•™è‚²/ç«èµ›ç±»å†…å®¹
#   - å¯¹è¾“å‡ºåšä¸¥æ ¼æ£€æµ‹ä¸é‡å†™
#   - æ”¯æŒOpenAI/Claudeç­‰ä»»æ„ç”Ÿæˆæ¨¡å‹
# ======================================================

import re

# ===============================
# 1ï¸âƒ£ ç”Ÿæˆå‰ï¼šç³»ç»Ÿæç¤ºè¯æ³¨å…¥
# ===============================
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€åæ‹›è˜AIåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç®€å†å†…å®¹ï¼Œåˆ†æå€™é€‰äººå’Œå²—ä½çš„åŒ¹é…ç¨‹åº¦ã€‚
è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹çº¦æŸï¼š
- ç¦æ­¢ç¼–é€ ä»»ä½•ç®€å†ä¸­ä¸å­˜åœ¨çš„ä¿¡æ¯ã€‚
- ç¦æ­¢ç”Ÿæˆæˆ–æåŠä»¥ä¸‹å†…å®¹ï¼šæ•°å­¦ç«èµ›ã€å¥¥æ•°ã€è¾…å¯¼å­¦ç”Ÿã€æ•™å­¦ã€æˆè¯¾ã€æ•™è‚²èƒŒæ™¯ã€è·å¥–ç»å†ã€‚
- é™¤éç®€å†æ˜ç¡®æåŠï¼Œä¸å¾—å‡è®¾å€™é€‰äººæœ‰æ•™å­¦æˆ–ç«èµ›ç»éªŒã€‚
- å¯¹é”€å”®ã€è¿è¥ã€é¡¾é—®ã€è¡Œæ”¿ã€æŠ€æœ¯å²—ä½ï¼Œåªèƒ½ç”Ÿæˆè¡Œä¸šé€šç”¨æè¿°ï¼Œå¦‚"æ²Ÿé€šèƒ½åŠ›å¼º""æœ‰å®¢æˆ·ç®¡ç†ç»éªŒ"ã€‚
"""

# ===============================
# 2ï¸âƒ£ è¾“å‡ºåï¼šæ¸…æ´—ä¸é‡å†™é€»è¾‘
# ===============================

FORBIDDEN_WORDS = [
    "ç«èµ›", "æ¯”èµ›", "è·å¥–", "è¾…å¯¼", "æ•™å­¦", "å­¦ç”Ÿ", "è¯¾å ‚", "è®²è§£",
    "æˆè¯¾", "æ•™è‚²èƒŒæ™¯", "æ•™å¸ˆ", "æ•™ç»ƒ", "åŸ¹è®­å­¦ç”Ÿ", "å¥¥æ•°", "ä¸€ç­‰å¥–", "äºŒç­‰å¥–"
]

FORBIDDEN_PATTERNS = [
    r"æ›¾è·.{0,10}(ç«èµ›|æ¯”èµ›|å¥–)",
    r"è·å¾—.{0,10}(å¥–é¡¹|ç«èµ›|å¥¥æ•°)",
    r"è¾…å¯¼.{0,10}(å­¦ç”Ÿ|ç«èµ›)",
    r"å…·å¤‡.{0,10}(æ•™å­¦|æˆè¯¾)ç»éªŒ",
    r"æŒ‡å¯¼.{0,10}å­¦ç”Ÿ",
    r"æ•™è‚²è¡Œä¸šèƒŒæ™¯",
    r"æ•°å­¦ç«èµ›",
    r"å¥¥æ•°"
]

REWRITE_TEXT = "å€™é€‰äººå…·å¤‡é”€å”®æ²Ÿé€šåŠå®¢æˆ·æœåŠ¡ç»éªŒï¼ŒèŒä¸šæ€åº¦ç§¯æã€‚"

def sanitize_ai_output(ai_text: str, job_title: str) -> str:
    """
    ğŸš€ é˜²å¹»è§‰ä¸»å‡½æ•°ï¼ˆç”Ÿæˆåæ‰§è¡Œï¼‰
    
    Args:
        ai_text: AIç”Ÿæˆçš„æ–‡æœ¬å†…å®¹
        job_title: å²—ä½åç§°
    
    Returns:
        æ¸…ç†åçš„æ–‡æœ¬ï¼Œå¦‚æœæ£€æµ‹åˆ°å¹»è§‰å†…å®¹åˆ™æ›¿æ¢ä¸ºä¸­æ€§æè¿°
    """
    if not ai_text:
        return ""

    text = ai_text.strip()

    # ä»…å¯¹éæ•™è‚²å²—ä½å¯ç”¨é˜²æŠ¤
    if not any(k in job_title for k in ["æ•™å¸ˆ", "è®²å¸ˆ", "è¾…å¯¼", "æ•™è‚²", "åŸ¹è®­å¸ˆ"]):
        # æ£€æµ‹æ˜¯å¦åŒ…å«å¹»è§‰å†…å®¹
        has_hallucination = False
        
        # ä½¿ç”¨æ­£åˆ™æ¨¡å¼æ£€æµ‹å’Œæ¸…ç†
        for pattern in FORBIDDEN_PATTERNS:
            if re.search(pattern, text):
                has_hallucination = True
                text = re.sub(pattern, "", text)
        
        # åˆ é™¤ç¦æ­¢è¯æ±‡
        for word in FORBIDDEN_WORDS:
            if word in text:
                has_hallucination = True
                text = text.replace(word, "")

        # æ¸…ç†å¤šä½™ç©ºæ ¼å’Œæ ‡ç‚¹
        text = re.sub(r"\s+", " ", text)
        text = re.sub(r"[ï¼Œã€‚ï¼›]{2,}", "ã€‚", text)
        text = text.strip()

        # æ£€æµ‹æ˜¯å¦æ®‹ç•™è™šå‡å†…å®¹ï¼ˆå®‰å…¨å…œåº•ï¼‰
        # å¦‚æœæ–‡æœ¬è¿‡çŸ­æˆ–ä»åŒ…å«ç¦æ­¢è¯æ±‡ï¼Œç›´æ¥é‡å†™
        if has_hallucination or len(text) < 15 or any(k in text for k in ["ç«èµ›", "å¥–", "è¾…å¯¼", "æ•™å­¦"]):
            text = REWRITE_TEXT

    # ç»Ÿä¸€æ ¼å¼
    text = re.sub(r"\s+", " ", text).strip()
    return text


# ===============================
# 3ï¸âƒ£ æµ‹è¯•åŒº
# ===============================
if __name__ == "__main__":
    print("=" * 70)
    print("ğŸ§ª AIè¾“å‡ºé˜²å¹»è§‰æ€»æ§æ¨¡å—æµ‹è¯•")
    print("=" * 70)
    
    examples = [
        {
            "job": "è¯¾ç¨‹é¡¾é—®",
            "ai": "å€™é€‰äººå…·å¤‡é«˜æ°´å¹³æ•°å­¦ç«èµ›èƒŒæ™¯å’Œä¸°å¯ŒåŸ¹è®­ç»éªŒï¼Œæ›¾æŒ‡å¯¼å¤šåå­¦ç”Ÿè·å¥–ã€‚"
        },
        {
            "job": "é”€å”®ç»ç†",
            "ai": "å€™é€‰äººè·å…¨å›½å¥¥æ•°äºŒç­‰å¥–ï¼Œå…·æœ‰æ•™å¸ˆåŸ¹è®­ç»éªŒã€‚"
        },
        {
            "job": "æ–°åª’ä½“è¿è¥",
            "ai": "å€™é€‰äººå…·å¤‡è¯¾å ‚æ•™å­¦ç»éªŒï¼Œè·å¾—æ•™è‚²ç«èµ›å¥–é¡¹ã€‚"
        },
        {
            "job": "Pythonå¼€å‘å·¥ç¨‹å¸ˆ",
            "ai": "å€™é€‰äººæŒ‡å¯¼å­¦ç”Ÿå‚åŠ ç¼–ç¨‹ç«èµ›å¹¶è·å¥–ã€‚"
        },
        {
            "job": "æ•™å¸ˆ",
            "ai": "å€™é€‰äººæœ‰æ•™å­¦ç»éªŒï¼Œæ“…é•¿è¾…å¯¼å­¦ç”Ÿã€‚"
        }
    ]

    for ex in examples:
        print(f"\nğŸ“‹ å²—ä½: {ex['job']}")
        print(f"ğŸ“ åŸå§‹è¾“å‡º: {ex['ai']}")
        print(f"âœ… æ¸…ç†å: {sanitize_ai_output(ex['ai'], ex['job'])}")
        print("-" * 70)
