# 评分规则与逻辑说明

**更新时间**: 2025-11-23  
**版本**: v2.0（已升级为基于证据链的评分系统）

---

## 📊 评分体系概览

系统采用**双轨评分机制**：
1. **AI 智能评分**（主要）：基于大语言模型的深度分析
2. **启发式规则评分**（备用）：当 AI 评分失败时的回退方案

---

## 🎯 评分维度

系统从 **4 个维度**对候选人进行评分，最终计算总分：

| 维度 | 满分 | 权重 | 说明 |
|------|------|------|------|
| **技能匹配度** | 25分 | 25% | 候选人的技能与岗位要求的匹配程度（基于简历中的动作证据） |
| **经验相关性** | 25分 | 25% | 候选人的工作经验与岗位的相关性（基于简历中的行为或经历） |
| **成长潜力** | 25分 | 25% | 候选人的学习能力和发展潜力（基于学习意愿、表达总结能力等） |
| **稳定性** | 25分 | 25% | 候选人的工作稳定性和长期性（基于任职时长、跳槽频率等） |

**总分计算公式**：
```
总分 = 技能匹配度 + 经验相关性 + 成长潜力 + 稳定性
（每个维度 0-25 分，总分 0-100 分）
```

**评分核心原则**：
1. 所有评分必须基于"简历中的真实证据"
2. 若无证据，则不给分或标记为 0
3. 每个维度都必须输出"动作证据 + 原文引用 + 推理理由"
4. 输出结构化，方便前端展示

---

## 🤖 AI 智能评分逻辑

### 1. 评分流程

```
输入：岗位名称 + JD文本 + 简历文本
  ↓
生成岗位能力模型（ability_model）
  ↓
调用大语言模型（LLM）进行深度分析
  ↓
输出结构化评分 JSON
  ↓
规范化处理（0-30/20 分制 → 0-100 分制）
  ↓
合并启发式评分（作为兜底）
```

### 2. AI 评分输出格式

AI 返回的原始分数范围（新版本）：
- `skill_match`: 0-25 分
- `experience_match`: 0-25 分
- `growth_potential`: 0-25 分
- `stability`: 0-25 分
- `final_score`: 0-100 分（四个维度相加）

**规范化公式**（映射到 0-100 分，用于前端显示）：
```python
规范化分数 = (原始分数 / 25) × 100
例如：skill_match = 20 → 规范化 = (20/25) × 100 = 80.0
```

**新的 JSON 结构**：
```json
{
  "score_detail": {
    "skill_match": {
      "score": 20,
      "evidence": [
        {
          "action": "电话回访",
          "resume_quote": "负责学员管理，定期电话回访家长",
          "reason": "该动作与岗位要求的客户沟通能力匹配"
        }
      ]
    },
    "experience_match": {...},
    "stability": {...},
    "growth_potential": {...},
    "final_score": 82
  },
  "risks": [
    {
      "risk_type": "跳槽频繁",
      "evidence": "3年换了4家公司",
      "reason": "可能影响工作稳定性"
    }
  ],
  "persona_tags": ["沟通型", "行动力强", "客户导向"],
  "resume_mini": "简历的简短 2–3 行摘要",
  "match_summary": "推荐/需重点关注/不匹配"
}
```

### 3. 岗位能力模型（Ability Model）

系统根据岗位名称自动生成能力模型，包含：
- **核心职责**（core_duties）
- **核心动作**（core_actions）
- **核心技能**（core_skills）
- **偏好经验**（preferred_exp）
- **风险点**（risks）
- **人才标签**（talent_tags）

**预设岗位模板**：
- **班主任/学管/教务**：学员管理、家长沟通、学习督导
- **销售/顾问/BD**：客户拓展、需求诊断、成交转化
- **运营/策划/活动**：活动策划、数据复盘、用户运营
- **其他岗位**：使用通用模板

### 4. AI 推理链（Reasoning Chain）

AI 会生成详细的推理链，包括：

**优势推理链**（strengths_reasoning_chain）：
- `conclusion`: 能力+动作导向的优势
- `detected_actions`: 简历中出现的动作/行为
- `resume_evidence`: 引用原文 + AI 解释
- `ai_reasoning`: 三段式推理（岗位需要 → 简历覆盖 → 构成优势）

**劣势推理链**（weaknesses_reasoning_chain）：
- `conclusion`: 基于缺失动作的劣势
- `resume_gap`: 明确缺失的动作
- `compare_to_jd`: 岗位模型为什么需要该动作
- `ai_reasoning`: 阐述风险（缺口 → 影响 → 结果）

---

## 🔧 启发式规则评分逻辑

当 AI 评分失败或返回空值时，系统自动回退到启发式规则评分。

### 1. 技能匹配度（Skill Match）

**计算方法**：
```python
# 1. 提取 JD 和简历的关键词
job_tokens = 提取 JD 文本的 Top 25 关键词
resume_tokens = 提取简历文本的所有关键词

# 2. 计算关键词重叠度
overlap = len(resume_tokens & job_tokens)
ratio = overlap / max(len(job_tokens), 1)

# 3. 映射到 45-98 分
skill_score = 45.0 + ratio × 70.0
```

**加分项**：
- **教育背景加成**：
  - 博士/PhD：+12 分
  - 硕士/Master：+8 分
  - 本科/Bachelor：+4 分
- **领域关键词加成**：
  - 命中领域关键词（物理、竞赛、教练、教学等）：每个 +4 分，最高 +15 分

**最终分数**：`skill_score = normalize(skill_score + edu_boost + domain_boost, 0, 100)`

### 2. 经验相关性（Experience Match）

**计算方法**：
```python
# 1. 基础分数：基于简历文本长度
base_exp_score = _length_score(text_len)
# 文本长度评分表：
# ≥4500字: 95分
# ≥3000字: 88分
# ≥2000字: 80分
# ≥1200字: 68分
# ≥600字:  55分
# <600字:  45分

# 2. 技能匹配度加成
exp_match_boost = skill_score × 0.3

# 3. 教育背景加成
edu_boost = education_skill_boost × 0.2

# 4. 最终分数
exp_score = normalize(base_exp_score × 0.7 + exp_match_boost + edu_boost, 0, 100)
```

**逻辑说明**：
- 简历越长，通常经验越丰富（70%权重）
- 技能匹配度高，经验相关性也相应提高（30%加成）
- 教育背景（硕博）通常伴随科研经验（20%加成）

### 3. 成长潜力（Growth Potential）

**计算方法**：
```python
# 1. 关键词计数
growth_keywords = ["学习", "成长", "复盘", "改进", "自我驱动", "迭代"]
hits = 统计简历中这些关键词的出现次数

# 2. 评分映射
if hits >= 6: return 92
if hits >= 4: return 82
if hits >= 2: return 73
if hits >= 1: return 64
else: return 55
```

**加分项**：
- 教育背景加成：
  - 博士：+10 分
  - 硕士：+6 分
  - 本科：+3 分

**最终分数**：`growth_score = normalize(growth_score + edu_growth_boost, 0, 100)`

### 4. 稳定性（Stability）

**计算方法**：
```python
# 1. 关键词计数
stability_keywords = ["稳定", "长期", "连续", "任职", "留任", "年度"]
hits = 统计简历中这些关键词的出现次数

# 2. 评分映射
if hits >= 5: return 90
if hits >= 3: return 78
if hits >= 1: return 68
else: return 60
```

**说明**：稳定性评分主要基于简历文本中的关键词，不涉及工作年限和跳槽次数。

---

## ⚙️ 配置文件

### `backend/configs/model_config.json`

```json
{
  "scoring_weights": {
    "skill_fit": 0.45,      // 传统规则评分权重（已弃用）
    "exp_relevance": 0.25,
    "stability": 0.15,
    "growth": 0.15
  },
  "confidence_threshold": 0.65,  // 置信度阈值
  "company_bias_whitelist": [    // 公司白名单（加分项）
    "在线教育", "K12", "职业教育", "成人教育", "培训机构"
  ]
}
```

**注意**：当前 AI 评分使用的权重是**硬编码**在代码中的：
- 技能匹配度：30%
- 经验相关性：30%
- 成长潜力：20%
- 稳定性：20%

---

## 🔄 评分合并逻辑

在 `ai_score_one()` 函数中，系统会：

1. **优先使用 AI 评分**：
   - 如果 AI 返回有效分数（非 fallback），使用 AI 分数
   - AI 分数会覆盖启发式分数

2. **回退到启发式评分**：
   - 如果 AI 调用失败
   - 如果 AI 返回 fallback 响应
   - 如果缺少必需输入（JD、简历、岗位名称）

3. **分数规范化**：
   - AI 返回的 0-30/20 分制 → 映射到 0-100 分制
   - 启发式评分已经是 0-100 分制

---

## 📈 评分示例

### 示例 1：AI 评分成功

**输入**：
- 岗位：课程顾问
- JD：包含"客户服务"、"学习督导"等关键词
- 简历：包含相关经验和技能

**AI 输出**（原始）：
```json
{
  "scores": {
    "skill_match": 24,        // 24/30 = 80.0
    "experience_match": 18,    // 18/30 = 60.0
    "growth_potential": 12,   // 12/20 = 60.0
    "stability": 10            // 10/20 = 50.0
  }
}
```

**规范化后**：
- 技能匹配度：80.0
- 经验相关性：60.0
- 成长潜力：60.0
- 稳定性：50.0

**总分计算**：
```
总分 = 80.0 × 0.30 + 60.0 × 0.30 + 60.0 × 0.20 + 50.0 × 0.20
     = 24.0 + 18.0 + 12.0 + 10.0
     = 64.0
```

### 示例 2：启发式评分

**输入**：
- 简历文本长度：2500 字
- 关键词重叠：15/25 = 60%
- 成长关键词：3 个
- 稳定性关键词：2 个
- 教育背景：硕士

**计算过程**：
1. **技能匹配度**：
   - 基础：45 + 0.6 × 70 = 87.0
   - 教育加成：+8
   - 最终：min(87 + 8, 100) = 95.0

2. **经验相关性**：
   - 基础：80（2500字）
   - 技能加成：95 × 0.3 = 28.5
   - 教育加成：8 × 0.2 = 1.6
   - 最终：80 × 0.7 + 28.5 + 1.6 = 85.1

3. **成长潜力**：
   - 基础：73（3个关键词）
   - 教育加成：+6
   - 最终：min(73 + 6, 100) = 79.0

4. **稳定性**：
   - 基础：68（2个关键词）
   - 最终：68.0

**总分**：
```
总分 = 95.0 × 0.30 + 85.1 × 0.30 + 79.0 × 0.20 + 68.0 × 0.20
     = 28.5 + 25.53 + 15.8 + 13.6
     = 83.43 ≈ 83.4
```

---

## 🛠️ 代码位置

### 核心文件

1. **AI 评分入口**：
   - `backend/services/ai_matcher.py` → `ai_score_one()`
   - `backend/services/ai_matcher.py` → `ai_match_resumes_df()`

2. **AI 洞察生成**：
   - `backend/services/ai_insights.py` → `generate_ai_insights()`

3. **启发式评分**：
   - `backend/services/ai_matcher.py` → `_heuristic_score_from_text()`
   - `backend/services/ai_matcher.py` → `_heuristic_match_resumes_df()`

4. **传统规则评分**（已弃用）：
   - `backend/core/scoring.py` → `compute_scores()`

5. **配置文件**：
   - `backend/configs/model_config.json`

---

## ⚠️ 注意事项

1. **权重不一致**：
   - `model_config.json` 中的权重（skill_fit: 0.45）**已不再使用**
   - 当前实际权重是硬编码的：30% / 30% / 20% / 20%

2. **AI 评分失败处理**：
   - 系统会自动回退到启发式评分
   - 不会出现"全 0 分"的情况

3. **分数范围**：
   - AI 原始分数：0-30（技能/经验），0-20（成长/稳定）
   - 规范化后：0-100（所有维度）
   - 最终总分：0-100

4. **置信度阈值**：
   - `confidence_threshold: 0.65` 用于传统规则评分
   - AI 评分不使用此阈值

---

## 🔍 调试建议

如果发现评分异常，可以：

1. **检查 AI 调用日志**：
   - 查看是否有 AI 调用失败
   - 查看返回的 JSON 是否有效

2. **验证启发式评分**：
   - 检查关键词提取是否正常
   - 检查文本长度计算是否正确

3. **对比 AI vs 启发式**：
   - 查看 `ai_score_one()` 的合并逻辑
   - 确认是否使用了正确的分数源

---

**文档结束**

